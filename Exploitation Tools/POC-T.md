POC-T v2.0 操作文档[转载]
===

## 0x00 功能介绍

> 脚本调用框架，用于渗透测试中 **采集|爬虫|爆破|批量PoC** 等需要并发的任务。
  
* 支持多线程/Gevent两种并发模式  
* 极简式脚本编写，无需参考文档  
* 内置脚本扩展及常用PoC函数  
* 支持第三方搜索引擎API(已完成ZoomEye/Shodan/Google)  
* PoC库更新中
   
![banner.png][2]



## 0x01 需求与设计


### 需求

安全技术人员经常遇到以下需求：

1. 新漏洞爆发，想要批量扫描公网主机并评估该漏洞影响。
2. 收集论坛内所有成员的公开信息。
3. 利用SSRF漏洞扫描内网主机及端口信息。
4. 对某C段IP反查域名

多次编码实现这些需求之后总结出它们的共性——**数据的并发处理**

解决这个问题的三个关键点：

* **数据**：数据怎么来？
* **处理**：逻辑是什么？
* **并发**：如何实现？

### 设计


我尝试设计一个框架统一解决以上需求，它的实现逻辑很简单：

1. 准备一个并发框架。
2. 将数据扔到框架中。
3. 将处理数据的逻辑扔到框架中。
4. 运行，获取处理结果。

因为数据的获取方式不同，处理数据的逻辑也不同，从而能满足漏洞验证、爬虫、爆破、扫描等不同需求。

这个图片清晰的描述了程序的设计思路：

![usage.png][3]

### 使用方法

接下来用实例说明该框架如何解决一开始我们提出的需求。

使用本框架，用户只需做两件事：

1. 编写一个函数
2. 执行一条命令

#### 漏洞验证

**示例：Apache Solr 未授权访问漏洞批量验证**

- 思路：
使用Shodan搜索引擎采集的IP作为数据输入，编写漏洞验证脚本作为数据的处理逻辑。

- 函数：

**判断给定的ip是否存在Solr未授权访问漏洞**

```
def poc(ip):
    g = requests.get('http://' + ip)
    if g.status_code is 200 and 'Solr Admin' in g.content and 'Dashboard' in g.content:
        return True # 漏洞存在
    return False # 漏洞不存在  
```

- 命令：`python POC-T.py -eT -s solr-unauth -aS "solr country:cn" --limit 10`
	
	* `-eT` 使用多线程
	* `-s solr-unauth` 加载名为 solr-unauth 的脚本 
	* `-aS "solr country:cn"` 指定 Shodan 搜索关键字
	* `--limit 10` 指定获取IP的数量：10条


#### 爬虫

**示例：B站用户签名档爬虫**

- 思路：将用户的ID作为数据输入，编写脚本下载该ID对应的用户签名作为数据的处理逻辑。  

- 脚本：[https://github.com/Xyntax/POC-T/blob/2.0/script/spider-example.py](https://github.com/Xyntax/POC-T/blob/2.0/script/spider-example.py)  

- 命令：`python POC-T.py -eG -s spider-example -iA 1-200000 -t 50`

	* `-eG` ： 使用单线程异步(协程)
	* `-iA 1-200000` ： 生成从1到200000的连续数字作为用户ID
	* `-t 50` ： 设置并发数量为50 

#### SSRF探测内网

**示例：利用 WebLogic SSRF 漏洞扫描内网**

- 思路：从外部文件中读取IP地址作为数据输入，编写脚本扫描指定IP的端口开放情况作为数据处理逻辑。  

- 脚本：[https://github.com/Xyntax/POC-T/blob/2.0/script/weblogic-ssrf-netmap.py](https://github.com/Xyntax/POC-T/blob/2.0/script/weblogic-ssrf-netmap.py)  

- 命令：`python POC-T.py -s weblogic-ssrf -iF iplist.txt`

	* `-iF iplist.txt` ： 从外部文件加载目标

#### 批量IP反查域名

**示例：利用Bing搜索引擎接口查询C段域名**

- 思路：生成IP地址作为数据输入，编写脚本调用Bing搜索引擎接口作为数据处理逻辑。  

- 脚本：[https://github.com/Xyntax/POC-T/blob/2.0/script/bingc.py](https://github.com/Xyntax/POC-T/blob/2.0/script/bingc.py)  

- 命令：`python POC-T.py -s bingc -iN 139.129.132.0/24`

	* `-iN 139.129.132.0/24` ： 根据指定地址段生成IP

#### PoC支持

针对漏洞验证，本项目中提供其它两项福利（详见Github项目介绍）：

* 公开PoC库：绝大部分为本人手工编写，均保证可用性、优化容错性，长期维护并更新。  
* PoC编写插件：根据以往的PoC编写经验，集成了实用的PoC插件，如：随机串生成，MD5生成，获取真实IP，Cloudeye接口等。

#### 与Pocsuite的差异

1. Seebug+Pocsuite+ZoomEye 一条龙服务确实很好用。Pocsuite的所有PoC需要按模板要求使用Pocsuite指定的函数，这样的优点在于可以在HTTP请求层面直接做控制，从而支持“全局代理”，“全局随机UA”等功能，同时保证了脚本的稳定性与规范性，对于不懂验证逻辑的客户或运维人员，直接运行脚本即可。  
2. 我在设计POC-T的初衷就是给脚本最大的自由度，可以引入第三方库，不需要任何模板和继承。这样既能够扩展其功能，又能保证效率的最大化，不用每次写脚本都查文档格式，一个脚本一行命令，三五分钟即可完成任务。缺点就是脚本的稳定性需要自己的编码能力和经验来保证。此外，POC-T提供更多的输入输出方式和第三方接口支持。

#### PoC相关
1. 曾经认为将大量PoC整合到一起即是最强大的“扫描器”。
然而现状是PoC开发水平良莠不齐，大部分容错性很差，真正集成到扫描器中需要二次开发。

2. 目前Bugscan收集了大量PoC，但是其编写者设置level的机制导致大部分PoC无法被获取。相比之下在Seebug付出一点时间就可以拿到自己想要的。

3. 练习PoC编写可以多关注新鲜的exp资源，如：[http://www.exploitalert.com/](http://www.exploitalert.com/)


## 0x02 快速开始   

`git clone https://github.com/Xyntax/POC-T`  
`pip install -r requirement.txt`   
`python POC-T.py`     
  
### 参数说明 

![usage.png][5] 

#### 结构  

以下含@的目录表示用户可控区域，用户可根据需要*增加|修改|调用*其中的内容

| 目录 | 说明 |
| :-----  |:-----|
| `POC-T.py` | 程序入口 |
| script     | @脚本库 |
| plugin       | @工具库 |
| data       | @资源库 |
| output     | 默认输出位置 |
| lib        | 项目代码 |
| doc        | 文档及版权声明 |
| thirdparty | 第三方库 |
| api        | 搜索引擎接口 |

## 0x03 编写脚本

编写自定义脚本，只需要声明一个函数作为接口，没有其他任何限制．  
从此告别文档，无需记忆函数名和模板调用，使效率最大化．

### 新建文件

* 进入`./script`目录
* 在此目录下新建Python文件 `poctest.py`

### 添加接口函数

* 在代码中添加函数 **poc()**
* 添加逻辑使验证成功(漏洞存在)时`return True`,验证失败时`return False`
* (程序运行时，每个子线程调用该文件的`poc()`方法，并将队列中的取出的字符串传入该方法)  

```
def poc(input_str):
    return True or false
```

### 查看及使用脚本

* `python POC-T.py --show` 查看`./script`文件夹下全部脚本名称
* 在命令行中使用 `-s poctest` 可加载`script`文件夹下的`poctest.py`脚本，或者 `-s /home/xy/xxx/poctest.py`加载任意路径的脚本
  
### 结果判断(可选)

针对一些复杂的需求，`poc()`函数可以使用多种返回值来控制验证状态和输出。  
以下模拟一个简单的密码爆破脚本代码  
  
```
def poc(input_str):
    url = 'http://xxx.com/login.php?pass=' + input_str
    try:
        c = requests.get(url).content
    except ConnectionError:
        return 2     # 把input_str再次加入任务队列重新验证(本次验证作废)
    if 'success' in c:
        return True  # 验证成功，屏幕结果输出为123456
        return 1     # 同上
        return url   # 验证成功，屏幕结果输出为"http://xxx.com/login.php?pass=123456"
    else
        return False # 验证失败，无输出
        return 0     # 同上

```

### 错误处理

建议在脚本中处理Exception，如果线程运行中发现Exception，将使框架终止全部任务并打印错误信息。  
由于网络请求中经常出现连接中断等错误，一种简单的做法是：

```
def poc(input_str)
    try:
    ...全部脚本逻辑...
    except:
        return False
```

## 0x03 脚本扩展工具 

`plugin`文件夹中收集了具有通用性的脚本扩展工具．用于简化代码，提高PoC准确性，赋予脚本更多功能.  
编写脚本时，可以使用`from plugin.xxx import xxx`直接调用，具体功能请查看原文件注释.  
  
|工具|说明|
|:---|:---|
|urlparser.py | URL处理工具,可对采集到的杂乱URL进行格式化/自动生成等|
|useragent.py | User-Agent处理工具,支持随机化UA以绕过防御规则|
|extracts.py  | 正则提取工具,从采集到的杂乱文本中筛选IP地址|
|static.py    | 存储静态资源,如常见端口号等 |
|util.py      | 常用函数,处理随机值/MD5/302跳转/格式转换等|
|cloudeye.py  | cloudeye.me功能接口,在PoC中查询DNS和HTTP日志|

## 0x04 第三方搜索引擎



本工具拟支持主流空间搜索引擎的API，目前已完成ZoomEye/Shodan/Google的集成。  
您可以通过简单的参数调用直接从搜索引擎中直接获取目标，并结合本地脚本进行扫描。

### 预配置（可选）

由于第三方接口需要认证，您可以在根目录下的 *tookit.conf* 配置文件中预先设置好您的API-KEY。  
如无预配置，程序将在运行时提示您输入API-KEY。 
关于各接口API-KEY的获取方法，请参考下文中引入的官方文档。

### ZoomEye

以下命令表示使用ZoomEye接口，搜索全网中开启 *8080* 号端口的服务，并使用 *test.py* 脚本进行验证．  
设置采集100个搜索结果，搜索结果将存入本地 *./data/zoomeye* 文件夹下．  

`python POC-T.py -s test -aZ "port:8080" --limit 100`  
  
ZoomEye现已开放注册，普通用户每月可以通过API下载5000页的搜索结果。  

* [ZoomEye-API官方文档](https://www.zoomeye.org/api/doc)

### Shodan

以下命令表示使用Shodan接口，搜索全网中关键字为 *solr* ，国家为 *cn* 的服务，并使用 *solr-unauth* 脚本进行漏洞验证．  
设置从第0条记录为起点，爬取10条记录，搜索结果将存入本地 *./data/shodan* 文件夹下．  
  
`python POC-T.py -s solr-unauth -aS "solr country:cn" --limit 10 --offset 0`  
  
Shodan-API接口使用限制及详细功能，可参考官方文档.

* [Shodan-API官方文档](https://developer.shodan.io/api/requirements)
* [查看Shodan账号的API-KEY](https://account.shodan.io/)

### Google

本程序使用 **Google Custom Search API** 对结果进行采集（即常说的 **Google-Hacking** ）。  
  
以下命令表示获取Google采集 *inurl:login.action* 的结果并批量验证S2-032漏洞。

`python POC-T.py -s s2-032 -aG "inurl:login.action"`

可使用 **--gproxy** 或者 **tookit.conf** 设置代理，代理格式为 *(sock4|sock5|http) IP PORT* ，仅支持这三种协议。  
例如：`--gproxy "sock5 127.0.0.1 7070"`

使用本接口需设定个人的API-KEY和所使用的自定义搜索引擎，二者均可在 *toolkit.conf* 配置。

填写示例

```
developer_key:AIzaSxxxxxxxxxxxxxxxxxxxxxxxxxxxxx_C1w
search_engine:011385053819762433240:ljmmw2mhhau
```

#### developer_key

获取API-KEY，使用API客户端：  
* [Google API Client - Python](https://developers.google.com/api-client-library/python/start/get_started)

#### search_engine
创建自定义搜索引擎（或直接使用示例中的值）：  
* [Google Custom Search API 开发者文档](https://developers.google.com/custom-search/docs/api)


## 0x05 内置脚本库


> 免责声明：请在合法范围内使用本程序。任何人因使用本程序造成的意外损失或恶意攻击，项目开发者对此概不负责，亦不承担任何法律责任。

> legal disclaimer: Usage of POC-T for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program.

### 漏洞验证 

|脚本|说明|
|:---|:---|
|`activemq-upload.py`    | ActiveMQ 文件上传 |
|`activemq-weakpass.py`    | ActiveMQ 弱口令 |
|`confluence-traversal.py`| Atlassian Confluence 文件读取 |
|`fastcgi-rce.py`| PHP FastCGI 文件读取/RCE |
|`phpcms9.6.0-getshell.py`| PHPCMS 9.6.0 member/index.php 文件上传Getshell |
|`phpcms9.6.0-sqli.py`| PHPCMS 9.6.0 down.php 前台注入 |
|`fiyo2.0.7-getshell.py`| FiyoCMS 文件上传GetShell | 
|`glassfish-traversal.py`| GlassFish 任意文件读取|
|`jboss-rce.py`       | JBoss 命令执行 (jexboss去后门版) |  
|`jetspeed-rest-unauth.py`| Apache Jetspeed REST API未授权访问|
|`joomla-registrationpro-sqli.py`| Joomla registrationpro组件SQL注入|
|`joomla-videoflow-sqli.py`| Joomla videoflow组件SQL注入|
|`joomla-videogallerylite-sqli.py`| Joomla Huge-IT videogallerylite 组件注入|
|`kubernetes-unauth`| Kubernetes API 未授权访问(作者:Oritz) |
|`maccms8-rce.py`| MACCMS(苹果CMS) vod-search 组件代码执行 (作者:potapo) |
|`memcached-unauth.py`    | Memcached 未授权访问 |
|`metinfo-504-sqli.py`| MetInfo 5.0.4 id参数SQL注入|
|`mongodb-unauth.py`| MongoDB 未授权访问 (作者:Double8)|
|`navis-webaccess-sqli.py`| Navis WebAccess SQL注入|
|`opensshd-user-enum.py`| Opensshd 用户猜解 |
|`phpmyadmin-auth-rce.py` | phpMyAdmin 登入后命令执行|
|`redis-unauth.py`    | Redis 未授权访问 |
|`redis-cron-getshell.py`| Redis利用之 cron.d|
|`redis-sshkey-getshell.py`| Redis利用之 ssh-key|
|`redis-web-probe.py`| Redis利用之 webshell|
|`resindoc-traversal.py`| resin-doc 文件读取/SSRF|
|`samsoftech-admin-bypass.py`| SAM Softech后台登录绕过|
|`shiro-deserial-rce.py`  | Apache Shiro 反序列化命令执行|
|`siemens-camera-getpwd.py`| SIEMENS IP-Camrea 密码泄露|
|`solr-unauth.py`     | Apache Solr 未授权访问 |
|`struts2-devmode.py` | Struts2 devMode 命令执行 |
|`struts2-s2032.py`   | Struts2 S2-032 命令执行 | 
|`struts2-s2045.py`   | Struts2 S2-045 命令执行 (作者:24'') | 
|`vbulletin-ssrf.py`| vBulletin SSRF |
|`weblogic-wls.py`|WebLogic Server WLS RCE (Author:starnight_cyber)|
|`wp-4.4-ssrf.py`| WordPress 4.4 SSRF |
|`wp-4.7-userinfo.py`| WordPress 4.7 REST API信息泄露 |
|`wp-4.7.1-restapi.py`| WordPress 4.7.1 REST API内容注入 |
|`wp-bonkersbeat-filedownload.py`| WordPress bonkersbeat theme 任意文件下载|
|`wp-forcedownload.py`| WordPress forcedownload 任意文件下载|
|`wp-ypo-filedownload.py`| WordPress ypo theme 任意文件下载|
|`zabbix-jsrpc-mysql-exp.py`| Zabbix jsrpc.php MySQL注入利用 (作者:B0t0w1)|
|`zabbix-jsrpc-sqli.py`  | Zabbix jsrpc.php SQL注入检测|
|`zonetransfer.py`| DNS域传送漏洞 |

### 爆破&扫描 

|脚本|说明|
|:---|:---|
|`brute-example.py`    | 表单爆破示例(51idc某站)|
|`rsync-weakpass.py`   | rsync 弱口令爆破|
|`zabbix-weakpass.py`  | zabbix 弱口令爆破|
|`weblogic-ssrf-netmap`|利用SSRF漏洞扫描内网端口(nmap 1000 ports)|
  
### 爬虫&采集

|脚本|说明|
|:---|:---|
|`spider-example.py`   |爬虫示例(B站用户签名档爬虫)|  
  
### 其他

|脚本|说明|
|:---|:---|
|`vote-example.py`     |给基友开发的刷票脚本|  
|`bingc.py`            |基于Bing搜索引擎的C段/旁站扫描(支持Bing-API)|  
|`check-cdn.py`        |探测网站是否使用CDN/云WAF(多节点Get)|  
  
  
## 0x06 致谢

* 进击的zjx - zone.wooyun.org  
 反馈Bug: IPy-ImportError
* 王若伊 - zone.wooyun.org  
 脚本改进建议: `script/struts2-s2032.py`
* CplusHua,小乐天 - knownsec  
 脚本改进建议: `script/struts2-devmode.py`
* B0t0w1  
 贡献脚本: `zabbix-jsrpc-mysql-exp.py`  
 反馈Bug: ZoomEye-API(1.x) --search-type=web 数据格式处理错误  
 反馈Bug: Shodan-API(1.x) --offset 参数范围判断错误  
* liuchengsn  
 反馈Bug: 参数错误提示有误(1.x)
* aug0st  
 反馈Bug: `/plugin/util.py - redirectURL()` 抛出连接错误导致程序中断  
* Double8  
 贡献脚本: `mongodb-unauth.py`
* ff0000  
 改进建议: 为错误的配置项增加提示  
* ivytin  
 改进建议: 为ZoomEye/Google API提供`--offset`参数功能  
* 24''  
 贡献脚本: `struts2-s2045.py`  
* githack2016  
 改进建议: 在Shodan-API回显中提供明确的错误原因  
* potapo  
 贡献脚本: `maccms8-rce.py`
* superfish9  
 反馈Bug: `poc()`函数未正确返回时将`None`视作正确结果输出  
* Oritz  
 贡献脚本: `kubernetes-unauth.py`  
* zy516668272@gmail.com  
 反馈Bug: `--config`参数报错  
* wjy397  
 修正Wiki参数拼写错误  
* bit4  
 贡献代码：Fofa API接口支持
* qiyuan  
 修正新版ZoomEye API  
* starnight_cyber  
 贡献脚本: `weblogic-wls.py`

本文转载，原链接[https://github.com/Xyntax/POC-T][1]

  [1]: https://github.com/Xyntax/POC-T
  [2]: http://47.75.189.175/usr/uploads/2018/05/3308734318.png
  [3]: http://47.75.189.175/usr/uploads/2018/05/4053459062.png
  [4]: http://img.blog.csdn.net/20160827210225502
  [5]: http://47.75.189.175/usr/uploads/2018/05/4053459062.png
